import { useState, useEffect, useRef } from 'react'
import {
  <% if (browserHistory) { %>
  BrowserRouter,
  <% } else { %>
  HashRouter,
  <% } %>
  useRouteChange,
} from '@wiscore/router'

import { loadScopeModule } from './loader'
import { loadScopeComponent } from './loaderComponent'
import { isFunction, isString, isUndefined, isObject, getRouterPath } from './helper'
import { enter, leave } from './app'

import Layout, { getLayoutName } from './Layout'
import Router from './Router'
import Suspense from './Suspense'
import Debug from './Debug'

window.$__wis_router_type__ = <% if (browserHistory) { %>'browserRouter'<% } else { %>'hashRouter'<% } %>

function isDebug() {
  return new URLSearchParams(window.location.search).get('debug') !== null
}

export function getAppName(hasLayout) {
  const routerPath = getRouterPath()
  const [layoutName = '', appName = ''] = routerPath.split('/').filter(item => item)
  const name = hasLayout ? appName : layoutName

  if (window.$__wis_uncheck_remote__(name)) {
    return name
  }
}

async function loadAppRouter(appName) {
  if (!appName) {
    return Router
  }

  const AppRouter = await loadScopeComponent(appName, './$$Router')
  return AppRouter
}

async function loadAppLifeCycle(appName) {
  if (!appName) {
    return { enter, leave }
  }

  const lifeCycle = await loadScopeModule(appName, './$$app')
  return lifeCycle
}

async function callLifeCycle(appName, name, params) {
  const lifeCycle = await loadAppLifeCycle(appName)
  if (!isFunction(lifeCycle[name])) return
  lifeCycle[name](params)
}

let preAppName
function useAppRouter() {
  const [state, setState] = useState({ basename: '', status: 'loading', AppRouter: null })

  async function load() {
    const layoutName = getLayoutName()
    const appName = getAppName(!!layoutName)

    const currState = {
      status: 'loading',
      basename: '',
      AppRouter: null,
    }
    setState({ ...currState })

    try {
      const AppRouter = await loadAppRouter(appName)
      currState.AppRouter = AppRouter
      currState.status = 'succeed'

      if (preAppName !== appName) {
        await callLifeCycle(preAppName, 'leave')
        await callLifeCycle(appName, 'enter')
      }

      preAppName = appName
    } catch (error) {
      currState.AppRouter = null
      currState.status = 'failed'
      console.error(error)
    }

    currState.basename = [layoutName, appName].filter(Boolean).join('/')

    setState(currState)
  }

  useEffect(() => {
    load()
  }, [])

  return [state, load]
}

export default function Root({ location }) {
  const [{ basename, status, AppRouter }, load] = useAppRouter()

  useEffect(() => {
    enter()
  }, [])

  <% if (!browserHistory) { %>
  useRouteChange(() => {
    load()
  })
  <% } %>

  function renderAppRouter() {
    if (!AppRouter) {
      return <Router basename={basename} />
    }

    return <AppRouter basename={basename} />
  }

  return (
    <Suspense>
      {(isDebug()) && <Debug />}
      <Layout>
        <Suspense mode="page">
          {renderAppRouter()}
        </Suspense>
      </Layout>
    </Suspense>
  )
}
