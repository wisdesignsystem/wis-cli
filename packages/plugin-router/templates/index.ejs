import { remotes } from './config'

function debug() {
  return new URLSearchParams(window.location.search).get('debug')
}

// 此模式下可编辑且生效
function isDebug() {
  return debug() === 'true' && process.env.NODE_ENV === 'development'
}

(async () => {
  window.$__wis_remotes__ = {}

  let urls = await remotes()

  const appName = '<%= appName %>'

  if (urls[appName] === undefined) {
    urls[appName] = process.env.PUBLIC_URL.slice(0, process.env.PUBLIC_URL.length - 1)
  }

  if (isDebug()) {
    try {
      const localUrls = window.sessionStorage.getItem(`${appName}__wis_remotes__`)
      urls = localUrls ? Object.assign(urls, JSON.parse(localUrls)) : urls
    } catch (e) {}
  }

  if (Proxy !== undefined) {
    window.$__wis_remotes__ = new Proxy({}, {
      get(_, prop) {
        if (!prop) {
          return
        }

        if (urls[prop] === undefined) {
          throw new Error(`Remote url not found for ${prop}`)
        }

        return urls[prop]
      },
    })
  } else {
    window.$__wis_remotes__ = urls
  }

  window.$__wis_uncheck_remote = function (name) {
    return urls[name]
  }

  import(/* webpackChunkName: "bootstrap" */'./bootstrap')
})()
